<!DOCTYPE html>

<meta charset="utf8">
<title>Корабли</title>

<canvas id = "main"></canvas>

<script> 
let a = 0
fly = {
    "x": 0.5,
    "y": -0.5,
    "angle" : 0,
    "speed" : 0.1,
    "x_to" : 3,
    "y_to" : 3
}  
allFly = [fly]
function goTo(who,x,y) {
    who.x_to = x;
    who.y_to = y;
}
function goGo(who) {
    let where = {
        "x": who.x_to,
        "y": who.y_to
    }
    let x = where.x - who.x
    let y = where.y - who.y
 //   if(Math.abs(x) < 0.01 && Math.abs(y) < 0.01) {a = 1; return 0} // нельзя перенаправить будет потом, зато не крутиться
    who.angle = Math.acos(x/Math.sqrt(x*x+y*y))*(Math.abs(y)/y)
    setTimeout(function() {
        let x = where.x - who.x
        let y = where.y - who.y
        who.x += 1 / Math.sqrt(x*x+y*y) * who.speed * x 
        who.y += 1 / Math.sqrt(x*x+y*y) * who.speed * y
        goGo(who,where) 
        }, 1000/60)
}
target = {
    "x": 3,
    "y": 3
}
goGo(fly,target);
//прорисовка    
window.onload = main

function main() {
    let gl = initCanvas("main")
    let program = initShaders(gl)
    let posIndex = gl.getAttribLocation(program, 'pos')
    let fooIndex = gl.getAttribLocation(program, 'foo')
    gl.useProgram(program)
    
    let count = initData(gl, posIndex, fooIndex)
    draw(gl,program,count);
}

function draw(gl,program,count){
    gl.clear(gl.COLOR_BUFFER_BIT)
    for(let i = 0; i < allFly.length; i++) {
            gl.uniform2f(gl.getUniformLocation(program, 'realPos'), allFly[i].x, allFly[i].y)
            gl.uniform1f(gl.getUniformLocation(program, 'alpha'), allFly[i].angle)
            drawData(gl,count)
    }
    setTimeout(function() {draw(gl,program,count)}, 1000/60)
}

function initData(gl, posIndex, fooIndex) {
    gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer())
    let x = Math.sqrt(3)/6
    let positions = [ 0.,2*x, 1, 0., 0., 0.,
                      0.5,-x, 1, 1., 0., 0.,
                     -0.5,-x, 1, 0., 0., 0.];

    gl.bufferData(gl.ARRAY_BUFFER, 
                  new Float32Array(positions), 
                  gl.STATIC_DRAW)
    
    gl.vertexAttribPointer(posIndex,
                           3,
                           gl.FLOAT,
                           false, 
                           24,
                           0)
    gl.enableVertexAttribArray(posIndex)  
                         
    gl.vertexAttribPointer(fooIndex,
                           3,
                           gl.FLOAT,
                           false, 
                           24,
                           12)
    gl.enableVertexAttribArray(fooIndex)

                           
    
    let count = positions.length / 6
    return count                
}

function drawData(gl,count) {
    gl.drawArrays(gl.TRIANGLES, 0, count)
}



function initCanvas(id) {
    let elem = document.getElementById(id)
    elem.width = 720
    elem.height = 720
    
    let gl = elem.getContext("webgl")
    
    gl.clearColor(0,1,0,1)
    gl.clear(gl.COLOR_BUFFER_BIT)
    
    return gl;
}
/////////////SHADERS BEGIN
let VS_SRC = `
attribute vec3 pos;
attribute vec3 foo;

varying vec3 fs_foo;

uniform vec2 realPos;
uniform float alpha;

vec2 rotate(float x, float y){ 
    float changing = sqrt(x*x + y*y);
    float x_changed = x/changing;
    float angle = acos(x_changed);
    if(y<0.) {angle = angle*-1.;}
    angle+=alpha + 3.14/6.;
    return vec2(cos(angle)*changing,sin(angle)*changing);
}
void main() {
    vec2 truePos = rotate(pos.x,pos.y);
    gl_Position = vec4(realPos.x+truePos.x,realPos.y+truePos.y,0.,pos.z*5.);
    fs_foo = foo;
}
`

let PS_SRC = `

precision mediump float;
varying vec3 fs_foo;

void main() {
    gl_FragColor = vec4(fs_foo.r,fs_foo.g,fs_foo.b,1.);
}
`
///////////////SHADERS END
function initShaders(gl) {
    let vs = gl.createShader(gl.VERTEX_SHADER)
    gl.shaderSource(vs, VS_SRC)
    gl.compileShader(vs)
    
    let vsLog = gl.getShaderInfoLog(vs)
    if (vsLog) {console.log(vsLog);}
    
    let fs = gl.createShader(gl.FRAGMENT_SHADER)
    gl.shaderSource(fs, PS_SRC)
    gl.compileShader(fs)
    
    let fsLog = gl.getShaderInfoLog(fs)
    if (fsLog) {console.log(fsLog);}
    
    let program = gl.createProgram()
    gl.attachShader(program, vs)
    gl.attachShader(program, fs)
    gl.linkProgram(program)
    
    return program

}





</script>
